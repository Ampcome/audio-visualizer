"use strict";var e=require("react/jsx-runtime"),n=require("react"),r=require("dat.gui"),t=require("three"),i=require("three/examples/jsm/controls/OrbitControls.js"),o=require("three/examples/jsm/postprocessing/EffectComposer.js"),u=require("three/examples/jsm/postprocessing/RenderPass.js"),c=require("three/examples/jsm/postprocessing/UnrealBloomPass.js"),a=require("three/examples/jsm/postprocessing/OutputPass.js");function s(e){var n=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var t=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(n,r,t.get?t:{enumerable:!0,get:function(){return e[r]}})}})),n.default=e,Object.freeze(n)}var l=s(t);exports.AudioVisualizer=({audioData:t,isListening:s,options:d={}})=>{const{initialQuality:m="medium",initialColors:g,initialBloom:f,showStats:v=!1,enableOrbitControls:p=!0,autoRotate:h=!1,showGui:y=!1,className:x=""}=d,w=n.useRef(null),b=n.useRef(null),z=n.useRef(null),P=n.useRef(null),_=n.useRef(null),C=n.useRef(null),A=n.useRef(null),M=n.useRef(null),R=n.useRef(null),S=n.useRef(null),D=n.useRef(0),E=n.useRef([]),[q,j]=n.useState({x:0,y:0}),[F,U]=n.useState(0),[k,L]=n.useState(m),O=n.useMemo((()=>{if("undefined"==typeof window)return{isMobile:!1,isLowEndDevice:!1,initialQuality:m};const e=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),n=e||(window.navigator.hardwareConcurrency||4)<=4;return{isMobile:e,isLowEndDevice:n,initialQuality:n?"low":m}}),[m]);n.useEffect((()=>{L(O.initialQuality)}),[O.initialQuality]);const I=e=>{switch(e){case"low":return.8;case"high":return 2;default:return 1.2}},B=n.useRef({u_time:{value:0},u_amplitude:{value:1.5},u_bass:{value:.5},u_mid:{value:.5},u_treble:{value:.5},u_red:{value:g?.red??1},u_green:{value:g?.green??1},u_blue:{value:g?.blue??1},u_detail:{value:I(k)}}),W=n.useRef({threshold:f?.threshold??.5,strength:f?.strength??.3,radius:f?.radius??.8});return n.useEffect((()=>{if(!w.current)return;B.current.u_detail.value=I(k);const e=new l.Scene;e.background=new l.Color(0),P.current=e;const n=new l.Clock;C.current=n;const t=new l.PerspectiveCamera(45,w.current?.clientWidth/w.current?.clientHeight,.1,1e3);t.position.set(0,-2,14),t.lookAt(0,0,0),_.current=t;try{const e=new l.WebGLRenderer({antialias:!0,alpha:!0,powerPreference:"high-performance",precision:"low"===k?"mediump":"highp"});e.setSize(w.current?.clientWidth,w.current?.clientHeight);const n=()=>{const e=window.devicePixelRatio||1;return O.isLowEndDevice?Math.min(e,1):"low"===k?Math.min(e,1.5):"medium"===k?Math.min(e,2):e};if(e.setPixelRatio(n()),e.outputColorSpace=l.SRGBColorSpace,w.current.firstChild&&w.current.removeChild(w.current.firstChild),w.current.appendChild(e.domElement),b.current=e,p){const n=new i.OrbitControls(t,e.domElement);n.enableDamping=!0,n.dampingFactor=.05,n.enableZoom=!0,n.autoRotate=h,n.update()}}catch(e){}const s=new l.ShaderMaterial({vertexShader:"\n// Simplified noise function based on simplex noise\n// Much more efficient than full Perlin noise implementation\nuniform float u_time;\n\nvec3 mod289(vec3 x)\n    {\n        return x - floor(x * (1.0 / 289.0)) * 289.0;\n    }\n\nvec4 mod289(vec4 x)\n    {\n        return x - floor(x * (1.0 / 289.0)) * 289.0;\n    }\n\nvec4 permute(vec4 x)\n    {\n        return mod289(((x*34.0)+10.0)*x);\n    }\n\nvec4 taylorInvSqrt(vec4 r)\n    {\n        return 1.79284291400159 - 0.85373472095314 * r;\n    }\n\nvec3 fade(vec3 t) {\n        return t*t*t*(t*(t*6.0-15.0)+10.0);\n    }\n\n// Classic Perlin noise, periodic variant\nfloat pnoise(vec3 P, vec3 rep)\n    {\n        vec3 Pi0 = mod(floor(P), rep); // Integer part, modulo period\n        vec3 Pi1 = mod(Pi0 + vec3(1.0), rep); // Integer part + 1, mod period\n        Pi0 = mod289(Pi0);\n        Pi1 = mod289(Pi1);\n        vec3 Pf0 = fract(P); // Fractional part for interpolation\n        vec3 Pf1 = Pf0 - vec3(1.0); // Fractional part - 1.0\n        vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n        vec4 iy = vec4(Pi0.yy, Pi1.yy);\n        vec4 iz0 = Pi0.zzzz;\n        vec4 iz1 = Pi1.zzzz;\n\n        vec4 ixy = permute(permute(ix) + iy);\n        vec4 ixy0 = permute(ixy + iz0);\n        vec4 ixy1 = permute(ixy + iz1);\n\n        vec4 gx0 = ixy0 * (1.0 / 7.0);\n        vec4 gy0 = fract(floor(gx0) * (1.0 / 7.0)) - 0.5;\n        gx0 = fract(gx0);\n        vec4 gz0 = vec4(0.5) - abs(gx0) - abs(gy0);\n        vec4 sz0 = step(gz0, vec4(0.0));\n        gx0 -= sz0 * (step(0.0, gx0) - 0.5);\n        gy0 -= sz0 * (step(0.0, gy0) - 0.5);\n\n        vec4 gx1 = ixy1 * (1.0 / 7.0);\n        vec4 gy1 = fract(floor(gx1) * (1.0 / 7.0)) - 0.5;\n        gx1 = fract(gx1);\n        vec4 gz1 = vec4(0.5) - abs(gx1) - abs(gy1);\n        vec4 sz1 = step(gz1, vec4(0.0));\n        gx1 -= sz1 * (step(0.0, gx1) - 0.5);\n        gy1 -= sz1 * (step(0.0, gy1) - 0.5);\n\n        vec3 g000 = vec3(gx0.x,gy0.x,gz0.x);\n        vec3 g100 = vec3(gx0.y,gy0.y,gz0.y);\n        vec3 g010 = vec3(gx0.z,gy0.z,gz0.z);\n        vec3 g110 = vec3(gx0.w,gy0.w,gz0.w);\n        vec3 g001 = vec3(gx1.x,gy1.x,gz1.x);\n        vec3 g101 = vec3(gx1.y,gy1.y,gz1.y);\n        vec3 g011 = vec3(gx1.z,gy1.z,gz1.z);\n        vec3 g111 = vec3(gx1.w,gy1.w,gz1.w);\n\n        vec4 norm0 = taylorInvSqrt(vec4(dot(g000, g000), dot(g010, g010), dot(g100, g100), dot(g110, g110)));\n        g000 *= norm0.x;\n        g010 *= norm0.y;\n        g100 *= norm0.z;\n        g110 *= norm0.w;\n        vec4 norm1 = taylorInvSqrt(vec4(dot(g001, g001), dot(g011, g011), dot(g101, g101), dot(g111, g111)));\n        g001 *= norm1.x;\n        g011 *= norm1.y;\n        g101 *= norm1.z;\n        g111 *= norm1.w;\n\n        float n000 = dot(g000, Pf0);\n        float n100 = dot(g100, vec3(Pf1.x, Pf0.yz));\n        float n010 = dot(g010, vec3(Pf0.x, Pf1.y, Pf0.z));\n        float n110 = dot(g110, vec3(Pf1.xy, Pf0.z));\n        float n001 = dot(g001, vec3(Pf0.xy, Pf1.z));\n        float n101 = dot(g101, vec3(Pf1.x, Pf0.y, Pf1.z));\n        float n011 = dot(g011, vec3(Pf0.x, Pf1.yz));\n        float n111 = dot(g111, Pf1);\n\n        vec3 fade_xyz = fade(Pf0);\n        vec4 n_z = mix(vec4(n000, n100, n010, n110), vec4(n001, n101, n011, n111), fade_xyz.z);\n        vec2 n_yz = mix(n_z.xy, n_z.zw, fade_xyz.y);\n        float n_xyz = mix(n_yz.x, n_yz.y, fade_xyz.x); \n        return 2.2 * n_xyz;\n    }\n\n// Uniforms\nuniform float u_amplitude;\nuniform float u_bass;\nuniform float u_mid;\nuniform float u_treble;\nuniform float u_detail;\n\n// Varying variables to pass to fragment shader\nvarying vec3 vNormal;\n\nvoid main() {\n  // Calculate noise based on position and time\n  // Use u_detail to control level of detail (lower = better performance)\n  float noise = 3.0 * pnoise(position + u_time, vec3(10.0));\n  \n  // Calculate displacement based on audio frequencies\n  float bassDisplacement = u_bass * noise * 0.5;\n  float midDisplacement = u_mid * noise * 0.3;\n  float trebleDisplacement = u_treble * noise * 0.2;\n  \n  // Combine displacements with amplitude control\n  float displacement = u_amplitude * (bassDisplacement + midDisplacement + trebleDisplacement) * (noise / 10.);\n  \n  // Apply displacement along normal direction\n  vec3 newPosition = position + normal * displacement;\n  \n  // Pass normal to fragment shader\n  vNormal = normal;\n  \n  // Set final position\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);\n}\n",fragmentShader:"\n// Color uniforms\nuniform float u_red;\nuniform float u_green;\nuniform float u_blue;\n\n// Varying variables received from vertex shader\nvarying vec3 vNormal;\n\nvoid main() {\n  // Apply color based on uniform values\n  gl_FragColor = vec4(vec3(u_red, u_green, u_blue), 1.0);\n}\n",wireframe:!0,uniforms:B.current}),d=(e=>{switch(e){case"low":return 20;case"high":return 40;default:return 30}})(k),m=new l.IcosahedronGeometry(4,Math.min(d,30));m.index&&(m.index.needsUpdate=!0),m.attributes.position.needsUpdate=!0,m.attributes.normal.needsUpdate=!0;const g=new l.Mesh(m,s);e.add(g),z.current=g;const f=new u.RenderPass(P.current,_.current),v=new c.UnrealBloomPass(new l.Vector2(w.current?.clientWidth,w.current?.clientHeight),W.current.strength,W.current.radius,W.current.threshold);M.current=v;const x=new a.OutputPass;if(b.current){const e=new o.EffectComposer(b.current);e.addPass(f),e.addPass(v),e.addPass(x),e.setSize(w.current?.clientWidth,w.current?.clientHeight),A.current=e}if(y){const e=new r.GUI;R.current=e;const n=e.addFolder("Colors");n.add(B.current.u_red,"value",0,1).name("Red"),n.add(B.current.u_green,"value",0,1).name("Green"),n.add(B.current.u_blue,"value",0,1).name("Blue"),n.open();const t=e.addFolder("Bloom");t.add(W.current,"threshold",0,1).name("Threshold").onChange((e=>{M.current&&(M.current.threshold=e)})),t.add(W.current,"strength",0,3).name("Strength").onChange((e=>{M.current&&(M.current.strength=e)})),t.add(W.current,"radius",0,1).name("Radius").onChange((e=>{M.current&&(M.current.radius=e)})),t.open();const i=e.addFolder("Settings");i.add({quality:k},"quality",["low","medium","high"]).name("Quality").onChange((e=>{L(e)})),i.open()}const D=()=>{if(!w.current||!b.current||!_.current)return;const e=w.current.clientWidth,n=w.current.clientHeight;_.current.aspect=e/n,_.current.updateProjectionMatrix(),b.current.setSize(e,n),A.current&&A.current.setSize(e,n)};return window.addEventListener("resize",D),()=>{window.removeEventListener("resize",D),S.current&&(cancelAnimationFrame(S.current),S.current=null),b.current&&w.current&&w.current.removeChild(b.current.domElement),z.current&&(z.current.geometry.dispose(),z.current.material.dispose()),R.current&&R.current.destroy()}}),[w.current?.clientWidth,w.current?.clientHeight,k,O.isLowEndDevice,p,h,y,g,f]),n.useEffect((()=>{const e=e=>{const n=window.innerWidth/2,r=window.innerHeight/2;j({x:(e.clientX-n)/100,y:(e.clientY-r)/100})};return window.addEventListener("mousemove",e),()=>{window.removeEventListener("mousemove",e)}}),[]),n.useEffect((()=>{if(!(P.current&&_.current&&C.current&&b.current&&z.current))return;const e=1e3/(e=>{switch(e){case"low":return 30;case"high":return 60;default:return 45}})(k),n=()=>{if(S.current=requestAnimationFrame(n),!(_.current&&P.current&&C.current&&b.current&&B.current&&z.current))return;const r=performance.now(),i=r-D.current;if(!(i<e)){if(v){const e=1e3/i;if(E.current.push(e),E.current.length>30&&E.current.shift(),E.current.length%10==0){const e=E.current.reduce(((e,n)=>e+n),0)/E.current.length;U(Math.round(e))}}_.current.position.x+=.05*(q.x-_.current.position.x),_.current.position.y+=.5*(-q.y-_.current.position.y),_.current.lookAt(P.current.position),B.current.u_time.value=C.current.getElapsedTime();try{if(t&&s&&t.length>0)try{const e=t.length,n=Math.max(1,Math.floor(e/64)),r=Math.floor(.1*e);let i=0;for(let e=0;e<r;e+=n)i+=t[e]||0;const o=i/Math.ceil(r/n)||0,u=r,c=Math.floor(.5*e);let a=0;for(let e=u;e<c;e+=n)a+=t[e]||0;const s=a/Math.ceil((c-u)/n)||0,l=c;let d=0;for(let r=l;r<e;r+=n)d+=t[r]||0;const m=d/Math.ceil((e-l)/n)||0,g=.7;B.current.u_bass.value=B.current.u_bass.value*(1-g)+o/255*7.5*g,B.current.u_mid.value=B.current.u_mid.value*(1-g)+s/255*7.5*g,B.current.u_treble.value=B.current.u_treble.value*(1-g)+m/255*7.5*g;const f=(o+s+m)/3;B.current.u_amplitude.value=B.current.u_amplitude.value*(1-g)+(.5+f/255*7.5)*g}catch(e){const n=C.current.getElapsedTime();B.current.u_amplitude.value=1+.3*Math.sin(.2*n)}else B.current.u_amplitude.value=0,B.current.u_bass.value=0,B.current.u_mid.value=0,B.current.u_treble.value=0,z.current&&(z.current.rotation.y+=.001);if(z.current&&(z.current.rotation.y+=.001),A.current)try{A.current.render()}catch(e){b.current.render(P.current,_.current)}else b.current.render(P.current,_.current);D.current=r}catch(e){}}};return S.current=requestAnimationFrame(n),()=>{S.current&&(cancelAnimationFrame(S.current),S.current=null)}}),[q,t,s,k,v]),e.jsx("div",{ref:w,"aria-label":"3D Audio Visualizer",style:{width:"100%",height:"100%",overflow:"hidden",backgroundColor:"#000",position:"relative",...d?.containerStyle},className:x,children:v&&e.jsxs("div",{style:{position:"absolute",top:"8px",right:"8px",backgroundColor:"rgba(0, 0, 0, 0.5)",color:"white",padding:"8px",borderRadius:"4px"},children:[e.jsxs("p",{children:["FPS: ",F]}),e.jsxs("p",{children:["Quality: ",k]})]})})},exports.useAudioListener=()=>{const[e,r]=n.useState(!1),[t,i]=n.useState((()=>{const e=new Uint8Array(128);for(let n=0;n<e.length;n++)e[n]=Math.floor(40+20*Math.sin(.1*n));return e})),[o,u]=n.useState(null),c=n.useRef(null),a=n.useRef(null),s=n.useRef(null),l=n.useRef(null),d=n.useRef(null),m=n.useCallback((()=>{l.current&&(cancelAnimationFrame(l.current),l.current=null),s.current&&(s.current.getTracks().forEach((e=>e.stop())),s.current=null),c.current&&"closed"!==c.current.state&&(c.current.close().catch(console.error),c.current=null),a.current=null,d.current=null}),[]);n.useEffect((()=>("undefined"!=typeof window&&(void 0!==window.AudioContext||void 0!==window.webkitAudioContext)&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||u("Your browser does not support the required audio APIs"),m)),[m]);return{isListening:e,audioData:t,error:o,startListening:n.useCallback((async()=>{try{if(m(),u(null),"undefined"==typeof window||void 0===window.AudioContext&&void 0===window.webkitAudioContext)throw new Error("Your browser does not support Web Audio API");if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Media Devices API not supported in this browser");const e=await navigator.mediaDevices.getUserMedia({audio:!0});s.current=e;const n=new(window.AudioContext||window.webkitAudioContext);c.current=n,"suspended"===n.state&&await n.resume();const t=n.createAnalyser();t.fftSize=512,t.smoothingTimeConstant=.7,t.minDecibels=-90,t.maxDecibels=-10,a.current=t;n.createMediaStreamSource(e).connect(t);const o=new Uint8Array(t.frequencyBinCount);d.current=o,t.getByteFrequencyData(o),i(new Uint8Array(o));const g=()=>{if(a.current&&d.current)try{a.current.getByteFrequencyData(d.current);const e=new Uint8Array(d.current);i(e),l.current=requestAnimationFrame(g)}catch(e){l.current&&(cancelAnimationFrame(l.current),setTimeout((()=>{l.current=requestAnimationFrame(g)}),100))}};l.current=requestAnimationFrame(g),r(!0)}catch(e){m();const n=e instanceof Error?e.message:"Failed to access microphone";u(n)}}),[m]),stopListening:n.useCallback((()=>{m(),r(!1);const e=new Uint8Array(128);for(let n=0;n<e.length;n++)e[n]=Math.floor(30+15*Math.sin(.1*n));i(e)}),[m])}};
//# sourceMappingURL=index.js.map
