{"version":3,"file":"index.js","sources":["../src/components/AudioVisualizer.tsx","../src/shaders/vertexShader.ts","../src/shaders/fragmentShader.ts","../src/hooks/useAudioListener.ts"],"sourcesContent":["import { useRef, useEffect, useState, useMemo, JSX } from \"react\";\r\n// three.js\r\nimport { GUI } from \"dat.gui\";\r\nimport * as THREE from \"three\";\r\nimport { OrbitControls } from \"three/examples/jsm/controls/OrbitControls.js\";\r\nimport { EffectComposer } from \"three/examples/jsm/postprocessing/EffectComposer.js\";\r\nimport { RenderPass } from \"three/examples/jsm/postprocessing/RenderPass.js\";\r\nimport { UnrealBloomPass } from \"three/examples/jsm/postprocessing/UnrealBloomPass.js\";\r\nimport { OutputPass } from \"three/examples/jsm/postprocessing/OutputPass.js\";\r\n// Shaders\r\nimport vertexShader from \"../shaders/vertexShader\";\r\nimport fragmentShader from \"../shaders/fragmentShader\";\r\n// Types\r\nimport {\r\n  VisualizerProps,\r\n  ShaderUniforms,\r\n  BloomParams,\r\n  ColorParams,\r\n} from \"../types\";\r\n\r\n/**\r\n * AudioVisualizer component that renders a 3D visualization of audio data\r\n * @param props Component props\r\n * @returns JSX.Element\r\n */\r\nexport const AudioVisualizer = ({\r\n  audioData,\r\n  isListening,\r\n  options = {},\r\n}: VisualizerProps): JSX.Element => {\r\n  const {\r\n    initialQuality = \"medium\",\r\n    initialColors,\r\n    initialBloom,\r\n    showStats = false,\r\n    enableOrbitControls = true,\r\n    autoRotate = false,\r\n    showGui = false,\r\n    className = \"\",\r\n  } = options;\r\n\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const rendererRef = useRef<THREE.WebGLRenderer | null>(null);\r\n  const meshRef = useRef<THREE.Mesh | null>(null);\r\n  const sceneRef = useRef<THREE.Scene | null>(null);\r\n  const cameraRef = useRef<THREE.PerspectiveCamera | null>(null);\r\n  const clockRef = useRef<THREE.Clock | null>(null);\r\n  const composerRef = useRef<EffectComposer | null>(null);\r\n  const bloomPassRef = useRef<UnrealBloomPass | null>(null);\r\n  const guiRef = useRef<GUI | null>(null);\r\n  const animationFrameRef = useRef<number | null>(null);\r\n  const lastFrameTimeRef = useRef<number>(0);\r\n  const fpsHistoryRef = useRef<number[]>([]);\r\n\r\n  // Mouse position state for camera movement\r\n  const [mousePosition, setMousePosition] = useState({ x: 0, y: 0 });\r\n\r\n  // Performance monitoring\r\n  const [fps, setFps] = useState<number>(0);\r\n  const [quality, setQuality] = useState<\"low\" | \"medium\" | \"high\">(\r\n    initialQuality\r\n  );\r\n\r\n  // Detect device capabilities\r\n  const deviceCapabilities = useMemo(() => {\r\n    if (typeof window === \"undefined\") {\r\n      return {\r\n        isMobile: false,\r\n        isLowEndDevice: false,\r\n        initialQuality: initialQuality,\r\n      };\r\n    }\r\n\r\n    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);\r\n    const isLowEndDevice =\r\n      isMobile || (window.navigator.hardwareConcurrency || 4) <= 4;\r\n    return {\r\n      isMobile,\r\n      isLowEndDevice,\r\n      initialQuality: isLowEndDevice\r\n        ? (\"low\" as const)\r\n        : (initialQuality as \"low\" | \"medium\" | \"high\"),\r\n    };\r\n  }, [initialQuality]);\r\n\r\n  // Set initial quality based on device capabilities\r\n  useEffect(() => {\r\n    setQuality(deviceCapabilities.initialQuality);\r\n  }, [deviceCapabilities.initialQuality]);\r\n\r\n  // Update detail level based on quality setting\r\n  const getDetailLevel = (qualitySetting: string): number => {\r\n    switch (qualitySetting) {\r\n      case \"low\":\r\n        return 0.8;\r\n      case \"high\":\r\n        return 2.0;\r\n      default:\r\n        return 1.2; // medium\r\n    }\r\n  };\r\n\r\n  // Shader uniforms with memoization to prevent unnecessary updates\r\n  const uniformsRef = useRef<ShaderUniforms>({\r\n    u_time: { value: 0.0 },\r\n    u_amplitude: { value: 1.5 },\r\n    u_bass: { value: 0.5 },\r\n    u_mid: { value: 0.5 },\r\n    u_treble: { value: 0.5 },\r\n    u_red: { value: initialColors?.red ?? 1.0 },\r\n    u_green: { value: initialColors?.green ?? 1.0 },\r\n    u_blue: { value: initialColors?.blue ?? 1.0 },\r\n    u_detail: { value: getDetailLevel(quality) }, // Control noise detail level\r\n  });\r\n\r\n  // Bloom parameters with default values\r\n  const bloomParamsRef = useRef<BloomParams>({\r\n    threshold: initialBloom?.threshold ?? 0.5,\r\n    strength: initialBloom?.strength ?? 0.3,\r\n    radius: initialBloom?.radius ?? 0.8,\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (!containerRef.current) return;\r\n\r\n    // Set detail level in uniforms\r\n    uniformsRef.current.u_detail.value = getDetailLevel(quality);\r\n\r\n    // Create scene\r\n    const scene = new THREE.Scene();\r\n    scene.background = new THREE.Color(0x000000);\r\n    sceneRef.current = scene;\r\n\r\n    // Create clock for animation\r\n    const clock = new THREE.Clock();\r\n    clockRef.current = clock;\r\n\r\n    // Create camera\r\n    const camera = new THREE.PerspectiveCamera(\r\n      45,\r\n      containerRef.current?.clientWidth / containerRef.current?.clientHeight,\r\n      0.1,\r\n      1000\r\n    );\r\n    camera.position.set(0, -2, 14);\r\n    camera.lookAt(0, 0, 0);\r\n    cameraRef.current = camera;\r\n\r\n    // Create renderer with optimized settings\r\n    try {\r\n      const renderer = new THREE.WebGLRenderer({\r\n        antialias: true, // Keep antialiasing for visual quality\r\n        alpha: true,\r\n        powerPreference: \"high-performance\",\r\n        precision: quality === \"low\" ? \"mediump\" : \"highp\",\r\n      });\r\n      renderer.setSize(\r\n        containerRef.current?.clientWidth,\r\n        containerRef.current?.clientHeight\r\n      );\r\n\r\n      // Use adaptive pixel ratio based on device capabilities\r\n      const getOptimalPixelRatio = () => {\r\n        const baseRatio = window.devicePixelRatio || 1;\r\n        if (deviceCapabilities.isLowEndDevice) return Math.min(baseRatio, 1);\r\n        if (quality === \"low\") return Math.min(baseRatio, 1.5);\r\n        if (quality === \"medium\") return Math.min(baseRatio, 2);\r\n        return baseRatio; // For high quality, use native ratio\r\n      };\r\n\r\n      renderer.setPixelRatio(getOptimalPixelRatio());\r\n      renderer.outputColorSpace = THREE.SRGBColorSpace;\r\n\r\n      // Clear any existing canvas\r\n      if (containerRef.current.firstChild) {\r\n        containerRef.current.removeChild(containerRef.current.firstChild);\r\n      }\r\n\r\n      containerRef.current.appendChild(renderer.domElement);\r\n      rendererRef.current = renderer;\r\n\r\n      // Add OrbitControls if enabled\r\n      if (enableOrbitControls) {\r\n        const controls = new OrbitControls(camera, renderer.domElement);\r\n        controls.enableDamping = true;\r\n        controls.dampingFactor = 0.05;\r\n        controls.enableZoom = true;\r\n        controls.autoRotate = autoRotate;\r\n        controls.update();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error creating WebGL renderer:\", error);\r\n    }\r\n\r\n    // Material with enhanced shaders for more robust animation\r\n    const material = new THREE.ShaderMaterial({\r\n      vertexShader: vertexShader,\r\n      fragmentShader: fragmentShader,\r\n      wireframe: true,\r\n      uniforms: uniformsRef.current,\r\n    });\r\n\r\n    // Create geometry with much higher detail to match original visualizer\r\n    // Using adaptive detail levels based on device capabilities\r\n    const getSubdivisions = (qualitySetting: string): number => {\r\n      switch (qualitySetting) {\r\n        case \"low\":\r\n          return 20; // Higher detail but still optimized for low-end devices\r\n        case \"high\":\r\n          return 40; // Match original visualizer's detail level\r\n        default:\r\n          return 30; // Good balance for medium quality\r\n      }\r\n    };\r\n\r\n    const subdivisions = getSubdivisions(quality);\r\n\r\n    // Create geometry with higher detail level\r\n    // Use buffer geometry for better performance with high vertex counts\r\n    const geometry = new THREE.IcosahedronGeometry(\r\n      4,\r\n      Math.min(subdivisions, 30)\r\n    );\r\n\r\n    // Apply geometry optimization techniques for better performance\r\n    if (geometry.index) {\r\n      geometry.index.needsUpdate = true;\r\n    }\r\n    geometry.attributes.position.needsUpdate = true;\r\n    geometry.attributes.normal.needsUpdate = true;\r\n\r\n    // Create mesh\r\n    const mesh = new THREE.Mesh(geometry, material);\r\n    scene.add(mesh);\r\n    meshRef.current = mesh;\r\n\r\n    // Create render pass\r\n    const renderScene = new RenderPass(sceneRef.current, cameraRef.current);\r\n\r\n    // Create bloom pass with adaptive settings based on quality\r\n    const bloomPass = new UnrealBloomPass(\r\n      new THREE.Vector2(\r\n        containerRef.current?.clientWidth,\r\n        containerRef.current?.clientHeight\r\n      ),\r\n      bloomParamsRef.current.strength,\r\n      bloomParamsRef.current.radius,\r\n      bloomParamsRef.current.threshold\r\n    );\r\n    bloomPassRef.current = bloomPass;\r\n\r\n    // Create output pass\r\n    const outputPass = new OutputPass();\r\n\r\n    // Create effect composer with the renderer instance\r\n    // TypeScript safety check to ensure renderer is not null\r\n    if (rendererRef.current) {\r\n      const composer = new EffectComposer(rendererRef.current);\r\n      composer.addPass(renderScene);\r\n      composer.addPass(bloomPass);\r\n      composer.addPass(outputPass);\r\n      composer.setSize(\r\n        containerRef.current?.clientWidth,\r\n        containerRef.current?.clientHeight\r\n      );\r\n      composerRef.current = composer;\r\n    }\r\n\r\n    // Add GUI if enabled\r\n    if (showGui) {\r\n      const gui = new GUI();\r\n      guiRef.current = gui;\r\n\r\n      // Add color controls\r\n      const colorFolder = gui.addFolder(\"Colors\");\r\n      colorFolder.add(uniformsRef.current.u_red, \"value\", 0, 1).name(\"Red\");\r\n      colorFolder.add(uniformsRef.current.u_green, \"value\", 0, 1).name(\"Green\");\r\n      colorFolder.add(uniformsRef.current.u_blue, \"value\", 0, 1).name(\"Blue\");\r\n      colorFolder.open();\r\n\r\n      // Add bloom controls\r\n      const bloomFolder = gui.addFolder(\"Bloom\");\r\n      bloomFolder\r\n        .add(bloomParamsRef.current, \"threshold\", 0, 1)\r\n        .name(\"Threshold\")\r\n        .onChange((value: number) => {\r\n          if (bloomPassRef.current) {\r\n            bloomPassRef.current.threshold = value;\r\n          }\r\n        });\r\n      bloomFolder\r\n        .add(bloomParamsRef.current, \"strength\", 0, 3)\r\n        .name(\"Strength\")\r\n        .onChange((value: number) => {\r\n          if (bloomPassRef.current) {\r\n            bloomPassRef.current.strength = value;\r\n          }\r\n        });\r\n      bloomFolder\r\n        .add(bloomParamsRef.current, \"radius\", 0, 1)\r\n        .name(\"Radius\")\r\n        .onChange((value: number) => {\r\n          if (bloomPassRef.current) {\r\n            bloomPassRef.current.radius = value;\r\n          }\r\n        });\r\n      bloomFolder.open();\r\n\r\n      // Add quality control\r\n      const settingsFolder = gui.addFolder(\"Settings\");\r\n      settingsFolder\r\n        .add({ quality }, \"quality\", [\"low\", \"medium\", \"high\"])\r\n        .name(\"Quality\")\r\n        .onChange((value: \"low\" | \"medium\" | \"high\") => {\r\n          setQuality(value);\r\n        });\r\n      settingsFolder.open();\r\n    }\r\n\r\n    // Handle window resize\r\n    const handleResize = () => {\r\n      if (!containerRef.current || !rendererRef.current || !cameraRef.current)\r\n        return;\r\n\r\n      const width = containerRef.current.clientWidth;\r\n      const height = containerRef.current.clientHeight;\r\n\r\n      cameraRef.current.aspect = width / height;\r\n      cameraRef.current.updateProjectionMatrix();\r\n\r\n      rendererRef.current.setSize(width, height);\r\n\r\n      if (composerRef.current) {\r\n        composerRef.current.setSize(width, height);\r\n      }\r\n    };\r\n\r\n    window.addEventListener(\"resize\", handleResize);\r\n\r\n    // Cleanup\r\n    return () => {\r\n      window.removeEventListener(\"resize\", handleResize);\r\n\r\n      if (animationFrameRef.current) {\r\n        cancelAnimationFrame(animationFrameRef.current);\r\n        animationFrameRef.current = null;\r\n      }\r\n\r\n      if (rendererRef.current && containerRef.current) {\r\n        containerRef.current.removeChild(rendererRef.current.domElement);\r\n      }\r\n\r\n      if (meshRef.current) {\r\n        meshRef.current.geometry.dispose();\r\n        (meshRef.current.material as THREE.Material).dispose();\r\n      }\r\n\r\n      if (guiRef.current) guiRef.current.destroy();\r\n    };\r\n  }, [\r\n    containerRef.current?.clientWidth,\r\n    containerRef.current?.clientHeight,\r\n    quality,\r\n    deviceCapabilities.isLowEndDevice,\r\n    enableOrbitControls,\r\n    autoRotate,\r\n    showGui,\r\n    initialColors,\r\n    initialBloom,\r\n  ]);\r\n\r\n  // Handle mouse movement for camera control\r\n  useEffect(() => {\r\n    const handleMouseMove = (e: MouseEvent) => {\r\n      const windowHalfX = window.innerWidth / 2;\r\n      const windowHalfY = window.innerHeight / 2;\r\n\r\n      setMousePosition({\r\n        x: (e.clientX - windowHalfX) / 100,\r\n        y: (e.clientY - windowHalfY) / 100,\r\n      });\r\n    };\r\n\r\n    window.addEventListener(\"mousemove\", handleMouseMove);\r\n\r\n    return () => {\r\n      window.removeEventListener(\"mousemove\", handleMouseMove);\r\n    };\r\n  }, []);\r\n\r\n  // Animation loop with frame limiting and adaptive quality\r\n  useEffect(() => {\r\n    if (\r\n      !sceneRef.current ||\r\n      !cameraRef.current ||\r\n      !clockRef.current ||\r\n      !rendererRef.current ||\r\n      !meshRef.current\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    // Target frame rate based on quality setting\r\n    const getTargetFPS = (qualitySetting: string): number => {\r\n      switch (qualitySetting) {\r\n        case \"low\":\r\n          return 30;\r\n        case \"high\":\r\n          return 60;\r\n        default:\r\n          return 45; // medium\r\n      }\r\n    };\r\n\r\n    const targetFPS = getTargetFPS(quality);\r\n    const frameInterval = 1000 / targetFPS;\r\n\r\n    const animate = (): void => {\r\n      animationFrameRef.current = requestAnimationFrame(animate);\r\n\r\n      if (\r\n        !cameraRef.current ||\r\n        !sceneRef.current ||\r\n        !clockRef.current ||\r\n        !rendererRef.current ||\r\n        !uniformsRef.current ||\r\n        !meshRef.current\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      // Frame rate limiting for consistent performance\r\n      const currentTime = performance.now();\r\n      const deltaTime = currentTime - lastFrameTimeRef.current;\r\n\r\n      if (deltaTime < frameInterval) {\r\n        return; // Skip this frame to maintain target FPS\r\n      }\r\n\r\n      // Calculate FPS for stats display\r\n      if (showStats) {\r\n        const fps = 1000 / deltaTime;\r\n        fpsHistoryRef.current.push(fps);\r\n        if (fpsHistoryRef.current.length > 30) {\r\n          fpsHistoryRef.current.shift();\r\n        }\r\n\r\n        // Update FPS display every 10 frames\r\n        if (fpsHistoryRef.current.length % 10 === 0) {\r\n          const avgFps =\r\n            fpsHistoryRef.current.reduce((sum, val) => sum + val, 0) /\r\n            fpsHistoryRef.current.length;\r\n          setFps(Math.round(avgFps));\r\n        }\r\n      }\r\n\r\n      // Camera follows mouse with smooth easing\r\n      cameraRef.current.position.x +=\r\n        (mousePosition.x - cameraRef.current.position.x) * 0.05;\r\n      cameraRef.current.position.y +=\r\n        (-mousePosition.y - cameraRef.current.position.y) * 0.5;\r\n      cameraRef.current.lookAt(sceneRef.current.position);\r\n\r\n      // Update time uniform\r\n      uniformsRef.current.u_time.value = clockRef.current.getElapsedTime();\r\n\r\n      try {\r\n        if (audioData && isListening && audioData.length > 0) {\r\n          // Audio reactive animation\r\n          try {\r\n            const bufferLength = audioData.length;\r\n\r\n            // Calculate frequency bands with reduced processing\r\n            // Process fewer samples for better performance\r\n            const sampleStep = Math.max(1, Math.floor(bufferLength / 64));\r\n\r\n            // Bass frequencies (low end)\r\n            const bassEnd = Math.floor(bufferLength * 0.1);\r\n            let bassSum = 0;\r\n            for (let i = 0; i < bassEnd; i += sampleStep) {\r\n              bassSum += audioData[i] || 0;\r\n            }\r\n            const bassAvg = bassSum / Math.ceil(bassEnd / sampleStep) || 0;\r\n\r\n            // Mid frequencies\r\n            const midStart = bassEnd;\r\n            const midEnd = Math.floor(bufferLength * 0.5);\r\n            let midSum = 0;\r\n            for (let i = midStart; i < midEnd; i += sampleStep) {\r\n              midSum += audioData[i] || 0;\r\n            }\r\n            const midAvg =\r\n              midSum / Math.ceil((midEnd - midStart) / sampleStep) || 0;\r\n\r\n            // Treble frequencies (high end)\r\n            const trebleStart = midEnd;\r\n            let trebleSum = 0;\r\n            for (let i = trebleStart; i < bufferLength; i += sampleStep) {\r\n              trebleSum += audioData[i] || 0;\r\n            }\r\n            const trebleAvg =\r\n              trebleSum /\r\n                Math.ceil((bufferLength - trebleStart) / sampleStep) || 0;\r\n\r\n            // Apply smoothing to prevent sudden jumps\r\n            const smoothingFactor = 0.7; // Higher value = more responsive\r\n\r\n            // Apply audio data to uniforms with high multipliers for visible effect\r\n            uniformsRef.current.u_bass.value =\r\n              uniformsRef.current.u_bass.value * (1 - smoothingFactor) +\r\n              (bassAvg / 255) * 7.5 * smoothingFactor;\r\n\r\n            uniformsRef.current.u_mid.value =\r\n              uniformsRef.current.u_mid.value * (1 - smoothingFactor) +\r\n              (midAvg / 255) * 7.5 * smoothingFactor;\r\n\r\n            uniformsRef.current.u_treble.value =\r\n              uniformsRef.current.u_treble.value * (1 - smoothingFactor) +\r\n              (trebleAvg / 255) * 7.5 * smoothingFactor;\r\n\r\n            // Overall amplitude based on average volume\r\n            const avgVolume = (bassAvg + midAvg + trebleAvg) / 3;\r\n            uniformsRef.current.u_amplitude.value =\r\n              uniformsRef.current.u_amplitude.value * (1 - smoothingFactor) +\r\n              (0.5 + (avgVolume / 255) * 7.5) * smoothingFactor;\r\n          } catch (error) {\r\n            console.error(\"Error in animation loop:\", error);\r\n            // Fall back to gentle animation on error\r\n            const time = clockRef.current.getElapsedTime();\r\n            uniformsRef.current.u_amplitude.value =\r\n              1.0 + Math.sin(time * 0.2) * 0.3;\r\n          }\r\n        } else {\r\n          // Idle animation with subtle movement\r\n          uniformsRef.current.u_amplitude.value = 0;\r\n          uniformsRef.current.u_bass.value = 0;\r\n          uniformsRef.current.u_mid.value = 0;\r\n          uniformsRef.current.u_treble.value = 0;\r\n\r\n          // Apply gentle rotation during idle state\r\n          if (meshRef.current) {\r\n            meshRef.current.rotation.y += 0.001;\r\n          }\r\n        }\r\n\r\n        // Apply slow rotation for better visual effect\r\n        if (meshRef.current) {\r\n          meshRef.current.rotation.y += 0.001;\r\n        }\r\n\r\n        // Render scene with post-processing\r\n        if (composerRef.current) {\r\n          try {\r\n            composerRef.current.render();\r\n          } catch (renderError) {\r\n            console.error(\"Error during composer render:\", renderError);\r\n            // Fallback to direct renderer if composer fails\r\n            rendererRef.current.render(sceneRef.current, cameraRef.current);\r\n          }\r\n        } else {\r\n          // Fallback to direct rendering if composer not available\r\n          rendererRef.current.render(sceneRef.current, cameraRef.current);\r\n        }\r\n\r\n        // Update last frame time\r\n        lastFrameTimeRef.current = currentTime;\r\n      } catch (error) {\r\n        console.error(\"Error in animation loop:\", error);\r\n      }\r\n    };\r\n\r\n    // Start animation loop\r\n    animationFrameRef.current = requestAnimationFrame(animate);\r\n\r\n    // Cleanup\r\n    return () => {\r\n      if (animationFrameRef.current) {\r\n        cancelAnimationFrame(animationFrameRef.current);\r\n        animationFrameRef.current = null;\r\n      }\r\n    };\r\n  }, [mousePosition, audioData, isListening, quality, showStats]);\r\n\r\n  return (\r\n    <div\r\n      ref={containerRef}\r\n      aria-label=\"3D Audio Visualizer\"\r\n      style={{\r\n        width: \"100%\",\r\n        height: \"100%\",\r\n        overflow: \"hidden\",\r\n        backgroundColor: \"#000\",\r\n        position: \"relative\",\r\n        ...options?.containerStyle,\r\n      }}\r\n      className={className}\r\n    >\r\n      {showStats && (\r\n        <div\r\n          style={{\r\n            position: \"absolute\",\r\n            top: \"8px\",\r\n            right: \"8px\",\r\n            backgroundColor: \"rgba(0, 0, 0, 0.5)\",\r\n            color: \"white\",\r\n            padding: \"8px\",\r\n            borderRadius: \"4px\",\r\n          }}\r\n        >\r\n          <p>FPS: {fps}</p>\r\n          <p>Quality: {quality}</p>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n","/**\r\n * Vertex shader for the audio visualizer\r\n * Implements Perlin noise-based displacement that reacts to audio frequencies\r\n */\r\nconst vertexShader = `\r\n// Simplified noise function based on simplex noise\r\n// Much more efficient than full Perlin noise implementation\r\nuniform float u_time;\r\n\r\nvec3 mod289(vec3 x)\r\n    {\r\n        return x - floor(x * (1.0 / 289.0)) * 289.0;\r\n    }\r\n\r\nvec4 mod289(vec4 x)\r\n    {\r\n        return x - floor(x * (1.0 / 289.0)) * 289.0;\r\n    }\r\n\r\nvec4 permute(vec4 x)\r\n    {\r\n        return mod289(((x*34.0)+10.0)*x);\r\n    }\r\n\r\nvec4 taylorInvSqrt(vec4 r)\r\n    {\r\n        return 1.79284291400159 - 0.85373472095314 * r;\r\n    }\r\n\r\nvec3 fade(vec3 t) {\r\n        return t*t*t*(t*(t*6.0-15.0)+10.0);\r\n    }\r\n\r\n// Classic Perlin noise, periodic variant\r\nfloat pnoise(vec3 P, vec3 rep)\r\n    {\r\n        vec3 Pi0 = mod(floor(P), rep); // Integer part, modulo period\r\n        vec3 Pi1 = mod(Pi0 + vec3(1.0), rep); // Integer part + 1, mod period\r\n        Pi0 = mod289(Pi0);\r\n        Pi1 = mod289(Pi1);\r\n        vec3 Pf0 = fract(P); // Fractional part for interpolation\r\n        vec3 Pf1 = Pf0 - vec3(1.0); // Fractional part - 1.0\r\n        vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\r\n        vec4 iy = vec4(Pi0.yy, Pi1.yy);\r\n        vec4 iz0 = Pi0.zzzz;\r\n        vec4 iz1 = Pi1.zzzz;\r\n\r\n        vec4 ixy = permute(permute(ix) + iy);\r\n        vec4 ixy0 = permute(ixy + iz0);\r\n        vec4 ixy1 = permute(ixy + iz1);\r\n\r\n        vec4 gx0 = ixy0 * (1.0 / 7.0);\r\n        vec4 gy0 = fract(floor(gx0) * (1.0 / 7.0)) - 0.5;\r\n        gx0 = fract(gx0);\r\n        vec4 gz0 = vec4(0.5) - abs(gx0) - abs(gy0);\r\n        vec4 sz0 = step(gz0, vec4(0.0));\r\n        gx0 -= sz0 * (step(0.0, gx0) - 0.5);\r\n        gy0 -= sz0 * (step(0.0, gy0) - 0.5);\r\n\r\n        vec4 gx1 = ixy1 * (1.0 / 7.0);\r\n        vec4 gy1 = fract(floor(gx1) * (1.0 / 7.0)) - 0.5;\r\n        gx1 = fract(gx1);\r\n        vec4 gz1 = vec4(0.5) - abs(gx1) - abs(gy1);\r\n        vec4 sz1 = step(gz1, vec4(0.0));\r\n        gx1 -= sz1 * (step(0.0, gx1) - 0.5);\r\n        gy1 -= sz1 * (step(0.0, gy1) - 0.5);\r\n\r\n        vec3 g000 = vec3(gx0.x,gy0.x,gz0.x);\r\n        vec3 g100 = vec3(gx0.y,gy0.y,gz0.y);\r\n        vec3 g010 = vec3(gx0.z,gy0.z,gz0.z);\r\n        vec3 g110 = vec3(gx0.w,gy0.w,gz0.w);\r\n        vec3 g001 = vec3(gx1.x,gy1.x,gz1.x);\r\n        vec3 g101 = vec3(gx1.y,gy1.y,gz1.y);\r\n        vec3 g011 = vec3(gx1.z,gy1.z,gz1.z);\r\n        vec3 g111 = vec3(gx1.w,gy1.w,gz1.w);\r\n\r\n        vec4 norm0 = taylorInvSqrt(vec4(dot(g000, g000), dot(g010, g010), dot(g100, g100), dot(g110, g110)));\r\n        g000 *= norm0.x;\r\n        g010 *= norm0.y;\r\n        g100 *= norm0.z;\r\n        g110 *= norm0.w;\r\n        vec4 norm1 = taylorInvSqrt(vec4(dot(g001, g001), dot(g011, g011), dot(g101, g101), dot(g111, g111)));\r\n        g001 *= norm1.x;\r\n        g011 *= norm1.y;\r\n        g101 *= norm1.z;\r\n        g111 *= norm1.w;\r\n\r\n        float n000 = dot(g000, Pf0);\r\n        float n100 = dot(g100, vec3(Pf1.x, Pf0.yz));\r\n        float n010 = dot(g010, vec3(Pf0.x, Pf1.y, Pf0.z));\r\n        float n110 = dot(g110, vec3(Pf1.xy, Pf0.z));\r\n        float n001 = dot(g001, vec3(Pf0.xy, Pf1.z));\r\n        float n101 = dot(g101, vec3(Pf1.x, Pf0.y, Pf1.z));\r\n        float n011 = dot(g011, vec3(Pf0.x, Pf1.yz));\r\n        float n111 = dot(g111, Pf1);\r\n\r\n        vec3 fade_xyz = fade(Pf0);\r\n        vec4 n_z = mix(vec4(n000, n100, n010, n110), vec4(n001, n101, n011, n111), fade_xyz.z);\r\n        vec2 n_yz = mix(n_z.xy, n_z.zw, fade_xyz.y);\r\n        float n_xyz = mix(n_yz.x, n_yz.y, fade_xyz.x); \r\n        return 2.2 * n_xyz;\r\n    }\r\n\r\n// Uniforms\r\nuniform float u_amplitude;\r\nuniform float u_bass;\r\nuniform float u_mid;\r\nuniform float u_treble;\r\nuniform float u_detail;\r\n\r\n// Varying variables to pass to fragment shader\r\nvarying vec3 vNormal;\r\n\r\nvoid main() {\r\n  // Calculate noise based on position and time\r\n  // Use u_detail to control level of detail (lower = better performance)\r\n  float noise = 3.0 * pnoise(position + u_time, vec3(10.0));\r\n  \r\n  // Calculate displacement based on audio frequencies\r\n  float bassDisplacement = u_bass * noise * 0.5;\r\n  float midDisplacement = u_mid * noise * 0.3;\r\n  float trebleDisplacement = u_treble * noise * 0.2;\r\n  \r\n  // Combine displacements with amplitude control\r\n  float displacement = u_amplitude * (bassDisplacement + midDisplacement + trebleDisplacement) * (noise / 10.);\r\n  \r\n  // Apply displacement along normal direction\r\n  vec3 newPosition = position + normal * displacement;\r\n  \r\n  // Pass normal to fragment shader\r\n  vNormal = normal;\r\n  \r\n  // Set final position\r\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);\r\n}\r\n`;\r\n\r\nexport default vertexShader;\r\n","/**\r\n * Fragment shader for the audio visualizer\r\n * Handles the coloring of the visualization\r\n */\r\nconst fragmentShader = `\r\n// Color uniforms\r\nuniform float u_red;\r\nuniform float u_green;\r\nuniform float u_blue;\r\n\r\n// Varying variables received from vertex shader\r\nvarying vec3 vNormal;\r\n\r\nvoid main() {\r\n  // Apply color based on uniform values\r\n  gl_FragColor = vec4(vec3(u_red, u_green, u_blue), 1.0);\r\n}\r\n`;\r\n\r\nexport default fragmentShader;\r\n","import { useState, useEffect, useRef, useCallback } from \"react\";\r\n\r\n/**\r\n * Audio listener state interface\r\n */\r\nexport interface AudioListenerState {\r\n  /**\r\n   * Whether the visualizer is currently listening to audio\r\n   */\r\n  isListening: boolean;\r\n\r\n  /**\r\n   * Audio frequency data array\r\n   */\r\n  audioData: Uint8Array | null;\r\n\r\n  /**\r\n   * Error message if microphone access fails\r\n   */\r\n  error: string | null;\r\n\r\n  /**\r\n   * Function to start listening to audio\r\n   */\r\n  startListening: () => void;\r\n\r\n  /**\r\n   * Function to stop listening to audio\r\n   */\r\n  stopListening: () => void;\r\n}\r\n\r\n/**\r\n * Custom hook for listening to audio from the microphone\r\n * @returns Audio listener state\r\n */\r\nexport const useAudioListener = (): AudioListenerState => {\r\n  const [isListening, setIsListening] = useState<boolean>(false);\r\n  const [audioData, setAudioData] = useState<Uint8Array | null>(() => {\r\n    // Initialize with placeholder data to ensure visualization starts immediately\r\n    const placeholderData = new Uint8Array(128);\r\n    for (let i = 0; i < placeholderData.length; i++) {\r\n      // Create a gentle wave pattern for initial visualization\r\n      placeholderData[i] = Math.floor(40 + 20 * Math.sin(i * 0.1));\r\n    }\r\n    return placeholderData;\r\n  });\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const audioContextRef = useRef<AudioContext | null>(null);\r\n  const analyserRef = useRef<AnalyserNode | null>(null);\r\n  const mediaStreamRef = useRef<MediaStream | null>(null);\r\n  const animationFrameRef = useRef<number | null>(null);\r\n  const dataArrayRef = useRef<Uint8Array | null>(null);\r\n\r\n  // Cleanup function to release resources\r\n  const cleanup = useCallback(() => {\r\n    if (animationFrameRef.current) {\r\n      cancelAnimationFrame(animationFrameRef.current);\r\n      animationFrameRef.current = null;\r\n    }\r\n\r\n    if (mediaStreamRef.current) {\r\n      mediaStreamRef.current\r\n        .getTracks()\r\n        .forEach((track: MediaStreamTrack) => track.stop());\r\n      mediaStreamRef.current = null;\r\n    }\r\n\r\n    if (audioContextRef.current && audioContextRef.current.state !== \"closed\") {\r\n      audioContextRef.current.close().catch(console.error);\r\n      audioContextRef.current = null;\r\n    }\r\n\r\n    analyserRef.current = null;\r\n    dataArrayRef.current = null;\r\n  }, []);\r\n\r\n  // Clean up resources when component unmounts\r\n  useEffect(() => {\r\n    // Ensure browser supports audio APIs before even attempting to use them\r\n    const browserSupported =\r\n      typeof window !== \"undefined\" &&\r\n      (typeof window.AudioContext !== \"undefined\" ||\r\n        typeof (window as any).webkitAudioContext !== \"undefined\") &&\r\n      navigator.mediaDevices &&\r\n      navigator.mediaDevices.getUserMedia;\r\n\r\n    if (!browserSupported) {\r\n      setError(\"Your browser does not support the required audio APIs\");\r\n    }\r\n\r\n    return cleanup;\r\n  }, [cleanup]);\r\n\r\n  /**\r\n   * Start listening to audio from the microphone\r\n   */\r\n  const startListening = useCallback(async (): Promise<void> => {\r\n    try {\r\n      // First clean up any existing resources\r\n      cleanup();\r\n      setError(null);\r\n\r\n      // Check if browser supports AudioContext\r\n      if (\r\n        typeof window === \"undefined\" ||\r\n        (typeof window.AudioContext === \"undefined\" &&\r\n          typeof (window as any).webkitAudioContext === \"undefined\")\r\n      ) {\r\n        throw new Error(\"Your browser does not support Web Audio API\");\r\n      }\r\n\r\n      // Check if mediaDevices API is available\r\n      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {\r\n        throw new Error(\"Media Devices API not supported in this browser\");\r\n      }\r\n\r\n      // Request microphone access\r\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n      mediaStreamRef.current = stream;\r\n\r\n      // Create audio context\r\n      const AudioContextClass =\r\n        window.AudioContext || (window as any).webkitAudioContext;\r\n      const audioContext = new AudioContextClass();\r\n      audioContextRef.current = audioContext;\r\n\r\n      // Resume audio context if it's suspended (needed for some browsers)\r\n      if (audioContext.state === \"suspended\") {\r\n        await audioContext.resume();\r\n      }\r\n\r\n      // Create analyser node with optimized settings\r\n      const analyser = audioContext.createAnalyser();\r\n      analyser.fftSize = 512; // Balanced value for performance and detail\r\n      analyser.smoothingTimeConstant = 0.7; // Slightly reduced for more responsive visualization\r\n      analyser.minDecibels = -90; // Increased sensitivity to quiet sounds\r\n      analyser.maxDecibels = -10; // Better dynamic range\r\n      analyserRef.current = analyser;\r\n\r\n      // Connect the microphone to the analyser\r\n      const source = audioContext.createMediaStreamSource(stream);\r\n      source.connect(analyser);\r\n\r\n      // Create data array for frequency data\r\n      const dataArray = new Uint8Array(analyser.frequencyBinCount);\r\n      dataArrayRef.current = dataArray;\r\n\r\n      // Initialize with some data to ensure visualization starts immediately\r\n      analyser.getByteFrequencyData(dataArray);\r\n      setAudioData(new Uint8Array(dataArray));\r\n\r\n      // Function to update audio data in animation frame\r\n      const updateAudioData = (): void => {\r\n        if (!analyserRef.current || !dataArrayRef.current) return;\r\n\r\n        try {\r\n          // Get frequency data from the analyser\r\n          analyserRef.current.getByteFrequencyData(dataArrayRef.current);\r\n\r\n          // Create a copy of the data array to avoid reference issues\r\n          const newData = new Uint8Array(dataArrayRef.current);\r\n          setAudioData(newData);\r\n\r\n          // Continue the animation loop\r\n          animationFrameRef.current = requestAnimationFrame(updateAudioData);\r\n        } catch (err) {\r\n          console.error(\"Error updating audio data:\", err);\r\n          // If there's an error, stop the animation frame but don't stop listening\r\n          // This prevents complete failure if there's a temporary glitch\r\n          if (animationFrameRef.current) {\r\n            cancelAnimationFrame(animationFrameRef.current);\r\n            // Try to restart the animation frame after a short delay\r\n            setTimeout(() => {\r\n              animationFrameRef.current =\r\n                requestAnimationFrame(updateAudioData);\r\n            }, 100);\r\n          }\r\n        }\r\n      };\r\n\r\n      // Start animation frame loop immediately\r\n      animationFrameRef.current = requestAnimationFrame(updateAudioData);\r\n      setIsListening(true);\r\n    } catch (err) {\r\n      cleanup();\r\n      const errorMessage =\r\n        err instanceof Error ? err.message : \"Failed to access microphone\";\r\n      setError(errorMessage);\r\n      console.error(\"Error accessing microphone:\", err);\r\n    }\r\n  }, [cleanup]);\r\n\r\n  /**\r\n   * Stop listening to audio from the microphone\r\n   */\r\n  const stopListening = useCallback((): void => {\r\n    cleanup();\r\n    setIsListening(false);\r\n\r\n    // Generate new placeholder data when stopping\r\n    const placeholderData = new Uint8Array(128);\r\n    for (let i = 0; i < placeholderData.length; i++) {\r\n      // Create a gentle wave pattern for idle visualization\r\n      placeholderData[i] = Math.floor(30 + 15 * Math.sin(i * 0.1));\r\n    }\r\n    setAudioData(placeholderData);\r\n  }, [cleanup]);\r\n\r\n  return {\r\n    isListening,\r\n    audioData,\r\n    error,\r\n    startListening,\r\n    stopListening,\r\n  };\r\n};\r\n"],"names":["audioData","isListening","options","initialQuality","initialColors","initialBloom","showStats","enableOrbitControls","autoRotate","showGui","className","containerRef","useRef","rendererRef","meshRef","sceneRef","cameraRef","clockRef","composerRef","bloomPassRef","guiRef","animationFrameRef","lastFrameTimeRef","fpsHistoryRef","mousePosition","setMousePosition","useState","x","y","fps","setFps","quality","setQuality","deviceCapabilities","useMemo","window","isMobile","isLowEndDevice","test","navigator","userAgent","hardwareConcurrency","useEffect","getDetailLevel","qualitySetting","uniformsRef","u_time","value","u_amplitude","u_bass","u_mid","u_treble","u_red","red","u_green","green","u_blue","blue","u_detail","bloomParamsRef","threshold","strength","radius","current","scene","THREE","Scene","background","Color","clock","Clock","camera","PerspectiveCamera","clientWidth","clientHeight","position","set","lookAt","renderer","WebGLRenderer","antialias","alpha","powerPreference","precision","setSize","getOptimalPixelRatio","baseRatio","devicePixelRatio","Math","min","setPixelRatio","outputColorSpace","SRGBColorSpace","firstChild","removeChild","appendChild","domElement","controls","OrbitControls","enableDamping","dampingFactor","enableZoom","update","error","material","ShaderMaterial","vertexShader","fragmentShader","wireframe","uniforms","subdivisions","getSubdivisions","geometry","IcosahedronGeometry","index","needsUpdate","attributes","normal","mesh","Mesh","add","renderScene","RenderPass","bloomPass","UnrealBloomPass","Vector2","outputPass","OutputPass","composer","EffectComposer","addPass","gui","GUI","colorFolder","addFolder","name","open","bloomFolder","onChange","settingsFolder","handleResize","width","height","aspect","updateProjectionMatrix","addEventListener","removeEventListener","cancelAnimationFrame","dispose","destroy","handleMouseMove","e","windowHalfX","innerWidth","windowHalfY","innerHeight","clientX","clientY","frameInterval","getTargetFPS","animate","requestAnimationFrame","currentTime","performance","now","deltaTime","push","length","shift","avgFps","reduce","sum","val","round","getElapsedTime","bufferLength","sampleStep","max","floor","bassEnd","bassSum","i","bassAvg","ceil","midStart","midEnd","midSum","midAvg","trebleStart","trebleSum","trebleAvg","smoothingFactor","avgVolume","time","sin","rotation","render","renderError","_jsx","ref","style","overflow","backgroundColor","containerStyle","children","_jsxs","top","right","color","padding","borderRadius","jsxs","setIsListening","setAudioData","placeholderData","Uint8Array","setError","audioContextRef","analyserRef","mediaStreamRef","dataArrayRef","cleanup","useCallback","getTracks","forEach","track","stop","state","close","catch","console","AudioContext","webkitAudioContext","mediaDevices","getUserMedia","startListening","async","Error","stream","audio","audioContext","resume","analyser","createAnalyser","fftSize","smoothingTimeConstant","minDecibels","maxDecibels","createMediaStreamSource","connect","dataArray","frequencyBinCount","getByteFrequencyData","updateAudioData","newData","err","setTimeout","errorMessage","message","stopListening"],"mappings":"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"}